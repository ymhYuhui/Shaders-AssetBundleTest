## 一. 渲染流水线

### 0.整体流程

1. (CPU)应用阶段： 准备基本场景数据 -> 加速算法、粗粒度剔除 -> 设置渲染状态、准备渲染参数 -> 调用DrawCall、输出渲染图元到显存
2. (GPU)几何阶段 ：顶点着色器 -> 曲面细分 -> 几何着色器 -> 顶点裁剪 -> 屏幕映射
3. (GPU)光栅化阶段 ：三角形（点/线）设置 -> 三角形（点/线）遍历 -> 片段着色器
4. (GPU)逐片元操作 ：裁剪测试 -> 透明度测试 -> 深度测试 -> 模板测试 -> 混合
5. (GPU)后处理

·
    顶点数据→ 顶点着色器（几何阶段）→ 几何着色器（几何阶段）→ 曲面细分着色器（几何阶段）→ 投影（几何阶段）→ 裁剪（几何阶段）→ 屏幕映射（几何阶段）→ 
    三角形设置（光栅化阶段）→三角形遍历（光栅化阶段）→ 片元着色器（光栅化阶段） → 逐片元操作（光栅化阶段）
    → 屏幕图像

- 顶点着色器，曲面细分着色器，几何着色器，片元着色器，可完全编程控制
- 裁剪，逐片元操作，可配置但不能编程
- 屏幕映射，三角形设置，三角形遍历，由GPU固定实现
- 顶点数据，屏幕图像不可编程不可配置

### 1.各阶段详细流程
#### 1.1 应用阶段 Application
CPU上，由应用程序驱动
1. 准备场景基本数据
   - 场景物体数据
     - 物体变换数据：位置、旋转、缩放等
     - 物体网格数据：顶点位置、UV贴图等 
   - 摄像机数据
     - 位置、方向
     - 远近裁剪平面
     - 正交/透视（FOV）
     - 视口比例、尺寸等
   - 光源及阴影数据
     - 设置光源
       - 方向光：颜色、方向
       - 点光：颜色、位置、范围
       - 聚光：颜色、位置、方向、内外圆锥角
     - 设置阴影
       - 是否需要阴影：判断该光源可见范围内是否有可投射阴影的物体
       - 阴影参数：对应光源序号、阴影强度、级联参数、深度偏移（优化相关）、近平面偏移（优化相关）
     - 逐光源绘制阴影贴图
       - 近平面偏移
       - 逐级联
         - 计算当前光源+级联对应的观察矩阵、投影矩阵、以及对应到阴影贴图里的视口区域
         - 绘制到阴影贴图
   - 其他全局数据
  
2. 加速算法、粗粒度提出
   - 碰撞检测
   - 加速算法
   - 遮挡剔除
     - 可见光裁剪
     - 可见场景物体裁剪 ：八叉树、BSP树、K-D树、BVH    
   - 其他算法
  
3. 设置渲染状态、准备渲染参数
   - 绘制设置
     - 使用着色器
     - 合批方式
   - 绘制顺序
     - 相对摄像机的距离
     - 材质RenderQueue
     - UICanvas
     - 其他方式等
   - 渲染目标
     - FrameBuffer
     - RenderTexture
   - 渲染模式
     - 前向渲染
     - 延迟渲染
4. 调用DrawCall、输出渲染图元到显存
   - 顶点数据 ：位置、颜色、法线、纹理UV坐标、其他顶点数据
   - 其他数据 ：MVP变换矩阵、纹理贴图、其他数据
    
#### 1.2 几何阶段 Geometry Processing
GPU

1. 顶点着色器 Vertex Shading （可编程）
   - 视图变换
   - 顶点着色
2. 曲面细分（可选）
   - 外壳着色器 Hull Shader
   - 曲面细分 tesselator
   - 域着色器 domain shader
3. 几何着色器（可选）
   - 基于图元的操作投影 Projection
   - 正交透视
4. 裁剪 Clipping
   - CVV
   - 正面或背面剔除（可配置）
5. 屏幕映射 Screen Mapping
   - 从连续到离散
   - 坐标系差异（OpenGL/D3D）


#### 1.3 光栅化阶段
GPU

1. 三角形设置 Triangle Setup
   - 计算微分、边方程和其他三角形数据
2. 抗锯齿
   - SSAA: 渲染到一个分辨率放大n倍的buffer对放大n倍的buffer下采样
   - MSAA:在光栅化阶段计算多个覆盖样本

#### 1.4 逐片元操作
GPU
1. 片元着色 Fragment Shader
2. 颜色混合 Color Blending
   - 透明度测试 Alpha test
   - 模板测试 stencil test
   - 深度测试 depth test
   - 混合 blending
3. 目标缓冲区 FrameBuffer
#### 1.5 后处理
- Bloom
- HDR
- FXAA
- Depth of View
- 边缘检测
- 径向模糊